C51 COMPILER V9.60.0.0   USER                                                              12/30/2022 17:33:04 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE USER
OBJECT MODULE PLACED IN .\Objects\user.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE mycode\user.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\
                    -user.lst) OBJECT(.\Objects\user.obj)

line level    source

   1          #include "user.h"
   2          
   3          //screen_pwm的极限范围1-100
   4          #define SCREEN_PWM_MIN 1
   5          #define SCREEN_PWM_MAX 80
   6          
   7          //cmp_pwm的极限范围0-100
   8          #define CMP_PWM_MIN 0
   9          #define CMP_PWM_MAX 80
  10          
  11          s16 cmp_pwm_result = 40;
  12          s16 screen_pwm_duty_limit = 80;
  13          
  14          void CLK_Init(void)
  15          {
  16   1              set_bit(P_SW2,7);//EAXFR 1:允许访问
  17   1              CLKSEL = 0x00;//内部24MHZ的IRC
  18   1              CLKDIV = 0;//MCLK/1
  19   1      }
  20          
  21          void GPIO_Init(void)
  22          {
  23   1              //P10准双向口
  24   1      //      reset_bit(P1M1,0);
  25   1      //      reset_bit(P1M0,0);
  26   1              //P11强推挽
  27   1              reset_bit(P1M1,1);
  28   1              set_bit(P1M0,1);
  29   1              //P35强推挽
  30   1              reset_bit(P3M1,5);
  31   1              set_bit(P3M0,5);
  32   1      }
  33          
  34          //比较器初始化
  35          void COPMPARE_Init(void)
  36          {
  37   1              CMPCR1 = 0x84;
  38   1              CMPCR2 = 0X0F;  
  39   1      }
  40          
  41          
  42          //比较器
  43          void cmp_pwm_duty_adjust(void)
  44          {
  45   1              u8 i = 0;
  46   1              static s16 pwm_duty_array[4] = {0};
  47   1              static u8 cmp_cnt = 0;
  48   1              static u16 cmp_cnt2 = 0;
  49   1              static s16 cmp_pwm_result_temp1 = 0;
  50   1              static s16 cmp_pwm_result_temp2 = 0;
  51   1      
  52   1              if(f_cmp_10ms)
  53   1              {
  54   2                      f_cmp_10ms = 0;                         
C51 COMPILER V9.60.0.0   USER                                                              12/30/2022 17:33:04 PAGE 2   

  55   2                      if(CMPCR1 & 0x01)
  56   2                      {       
  57   3                              if(cmp_pwm_duty < CMP_PWM_MAX)
  58   3                              {
  59   4                                      cmp_pwm_duty += 1;
  60   4                              }
  61   3                      }
  62   2                      else
  63   2                      {
  64   3                              if(cmp_pwm_duty > CMP_PWM_MIN)
  65   3                              {
  66   4                                      cmp_pwm_duty -= 1;
  67   4                              }
  68   3                      }
  69   2      
  70   2                      
  71   2                      pwm_duty_array[cmp_cnt] = cmp_pwm_duty;
  72   2                      cmp_cnt++;
  73   2                      if(cmp_cnt >= 4)
  74   2                      {
  75   3                              cmp_cnt = 0;
  76   3                              cmp_pwm_result_temp1 = 0;
  77   3                              for(i = 0;i < 4;i++)
  78   3                              {
  79   4                                      cmp_pwm_result_temp1 += pwm_duty_array[i];
  80   4                              }
  81   3                              cmp_pwm_result_temp1 /= 4;
  82   3                      }                                       
  83   2                      
  84   2                      
  85   2                      if((cmp_pwm_result_temp1 < cmp_pwm_result_temp2 - 2) || (cmp_pwm_result_temp1 > cmp_pwm_result_temp2 + 2
             -))
  86   2                      {
  87   3                              cmp_cnt2++;
  88   3                              if(cmp_cnt2 >= 500)
  89   3                              {
  90   4                                      cmp_cnt2 = 0;
  91   4                                      if(cmp_pwm_result_temp1 <= 5)
  92   4                                      {
  93   5                                              cmp_pwm_result = 50;
  94   5                                              //cmp_pwm_result = (800 - cmp_pwm_result_temp1*15)/10;
  95   5                                      }
  96   4                                      else
  97   4                                      {
  98   5                                              cmp_pwm_result = (200 - cmp_pwm_result_temp1*3)/10;
  99   5                                      }                               
 100   4                                      cmp_pwm_result_temp2 = cmp_pwm_result_temp1;
 101   4                              }                               
 102   3                      }
 103   2                      else    
 104   2                      {
 105   3                              cmp_cnt2 = 0;
 106   3                      }                       
 107   2              }
 108   1      }
 109          
 110          //屏幕亮度调节
 111          void screen_pwm_duty_adjust(void)
 112          {       
 113   1              static u8 screen_t1 = 0;
 114   1              if(f_screen_10ms)
 115   1              {
C51 COMPILER V9.60.0.0   USER                                                              12/30/2022 17:33:04 PAGE 3   

 116   2                      f_screen_10ms = 0;
 117   2                      screen_t1++;
 118   2                      if(screen_t1 >= 3)
 119   2                      {
 120   3                              screen_t1 = 0;  
 121   3                              
 122   3                              if(cmp_pwm_result > SCREEN_PWM_MAX)
 123   3                              {
 124   4                                      cmp_pwm_result = SCREEN_PWM_MAX;
 125   4                              }
 126   3                              else if(cmp_pwm_result < SCREEN_PWM_MIN)
 127   3                              {
 128   4                                      cmp_pwm_result = SCREEN_PWM_MIN;
 129   4                              }               
 130   3                              
 131   3                              if(screen_pwm_duty < cmp_pwm_result)
 132   3                              {
 133   4                                      screen_pwm_duty++;
 134   4                              }
 135   3                              else if(screen_pwm_duty > cmp_pwm_result)
 136   3                              {                                                                       
 137   4                                      screen_pwm_duty--;                      
 138   4                              }                               
 139   3                      }
 140   2              }
 141   1      }
 142          
 143          
 144          
 145                                          
 146          
 147          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    414    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     20    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
